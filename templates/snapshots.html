
<h2>{{ escape(title) }}</h2>

<form method="post">
<div class="container-fluid lib-treeview">
	<div class="row">

		<div class="col-md-5">
			<div id="snapshot-tree"></div>
			<div class="input-group">
				<span class="input-group-addon">
					<label>New bank</label>
				</span>
				<input  name="NEW_BANK_NUM" value="{{ config['NEXT_BANK_NUM'] }}" class="form-control">
				<span class="input-group-btn">
					<button class="btn btn-default btn-block" name="ACTION" value="NEW_BANK">
					<span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
				</span>
			</div>
		</div>

		<div id="snapshot-panel" class="col-md-7">
			<div class="row">
				<div class="col-md-12">
					<label>Name:</label>
					<input id="SEL_NAME" name="SEL_NAME" class="form-control" />
					<input type="hidden" id="SEL_FULLPATH" name="SEL_FULLPATH" />
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<label>Bank:</label>
					<input type="hidden" id="SEL_BANK_NUM" name="SEL_BANK_NUM" />
					<select id="SEL_BANK" name="SEL_BANK"
						class="form-control">
						{% for option in config['BANKS'] %}
							<option value="{{  option  }}" >{{ option }}</option>
						{% end %}
					</select>
				</div>
				<div class="col-md-6">
					<label>Program:</label>
					<select id="SEL_PROG_NUM" name="SEL_PROG_NUM"
						class="form-control">
						{% for option in config['PROGS_NUM'] %}
							<option value="{{  option  }}" >{{ option }}</option>
						{% end %}
					</select>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<textarea id="SEL_PROG_DETAILS" name="SEL_PROG_DETAILS" rows="6" readonly></textarea>
				</div>
			</div>
			
			{% if errors %}
			<div class="row">
				<div class="col-md-12">
					<div class="alert alert-danger">{{ errors }}</div>
				</div>
			</div>
			{% end %}

			<div class="row">
				<div class="col-md-12">
					<button name="ACTION" value="REMOVE" onclick="return confirm('Are you sure?');" class="btn btn-danger btn-block">DELETE</button>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<button name="ACTION" value="SAVE" class="btn btn-lg btn-theme btn-block">Save</button>
				</div>
			</div>

		</div>
	</div>
</div>
</form>

<script type="text/javascript">

$('#snapshot-panel').hide();
$('#zynthian-selection-customized-panel').hide();
$('#snapshot-tree').treeview({data: JSON.parse('{% raw config['SNAPSHOTS'].replace("'", "&#39;") %}'), bootstrap2: true ,
	emptyIcon: "glyphicon glyphicon-floppy-disk",
	expandIcon: "glyphicon glyphicon-folder-close",
	collapseIcon: "glyphicon glyphicon-folder-open",
	onNodeSelected: function(event, data) {
		$("#SEL_NAME")[0].value = data.name.replace("&#39;","'");
		$("#SEL_FULLPATH")[0].value = data.fullpath;
		$("#SEL_BANK_NUM")[0].value = data.bank_num;
		$("#SEL_BANK")[0].value = data.bank_num + (data.bank_name? '-' + data.bank_name.replace("&#39;","'") : '');
		$("#SEL_BANK")[0].disabled = data.nodes;
		$("#SEL_PROG_NUM")[0].value = data.prog_num;
		$("#SEL_PROG_NUM")[0].disabled = data.nodes;
		$("#SEL_PROG_DETAILS")[0].disabled = false;
		if (data.prog_details){
			$("#SEL_PROG_DETAILS").show();
			$("#SEL_PROG_DETAILS")[0].value = formatSnapshotDetails(data.prog_details);
		} else {
			$("#SEL_PROG_DETAILS").hide();
		}
		$('#snapshot-panel').show();
	}
});
$('#snapshot-tree').treeview('selectNode',{% raw config['SEL_NODE_ID'] %});

function formatSnapshotDetails(snapshotDetails){
	var result = "";
	for (var ch=0; ch<16; ch++) {
		ch_layout = "";
		for (idx in snapshotDetails.layers) {
			layer = snapshotDetails.layers[idx]
			if (ch==layer.midi_chan) {
				if (ch_layout!="") ch_layout += "  ->";
				else  ch_layout += (layer.midi_chan + 1) + '#';
				ch_layout += layer.engine_nick + ">"
				if (layer.bank_name) ch_layout += layer.bank_name + "/";
				if (layer.preset_name) ch_layout += layer.preset_name;
				ch_layout += "\n";
			}
		}
		result += ch_layout;
	}
	return result;
}

</script>
